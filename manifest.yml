launch:
    parameters:
        - app-tier-size:
            description: Number of servers in app tier
            default: 1
            min: 1
            max: 20
        - app-fork:
            description: Source control fork
            default: "graven"
        - app-branch:
            description: Source control branch
            default: "oracle"
            enum:
                "Green": "oracle"
                "Red": "oracle-red"
        - db-user:
             description: Oracle DB user
             default: "JOHN"
        - db-password:
             description: Oracle DB user password
             default: "123qwe123"
        - db-sid:
             description: Oracle DB SID
             default: "DBORA"

    steps:
        - provision-app-tier:
            action: compute.grow
            parameters:
                vmIdentity: root
                imageId: us-east-1/ami-3aeb7853
                quantity: ${app-tier-size}
                roleName: app-node
            output:
                app-hosts: ips

        - provision-db-tier:
            action: compute.grow
            parameters:
                vmIdentity: root
                imageId: us-east-1/ami-4ab52723
                roleName: db-node
            output:
                 db-hosts: ips
 
        - provision-lb:
            action: compute.grow
            parameters:
                roleName: lb-node
            output:
                lb-hosts: ips
 
        - install-database:
            action: install
            parameters:
                phase: install-db
                roles: [ db-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[oracledb::dbca]"]
                jattrs:
                    oracle:
                        db:
                            sid: ${db-sid}
                            schema: ${db-user}
                            schema_password: ${db-password}

        - install-app:
            action: install
            parameters:
                phase: install-app
                roles: [ app-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[weblogic::wl_create_domain]", "recipe[weblogic::wl_domain_start]"]
                jattrs:
                    weblogic:
                        wl_domain_port: 8080
                        wl_home: "/opt/oracle/middleware/wlserver_10.3/"
                        oracle_home: "/opt/oracle/middleware/"
                        jdk: "/usr/java/latest"

        - install-lb:
            action: haproxy.install
            parameters:
                phase: install-lb
                roles: [ lb-node ]
 
        - deploy-database:
            action: install
            parameters:
                phase: deploy-db
                precedingPhases: [ install-db ]
                roles: [ db-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[oracledb::dataload]"]
                jattrs:
                    oracle:
                        db:
                            dataload: [
                                "https://raw.github.com/${app-fork}/petclinic/${app-branch}/src/main/resources/db/oracle/petclinic-oracle-schema.sql",
                                "https://raw.github.com/${app-fork}/petclinic/${app-branch}/src/main/resources/db/oracle/petclinic-oracle-dataload.sql"
                            ]


        - configure-datasource:
            action: install
            parameters:
                phase: configure-datasource
                precedingPhases: [ install-db, install-app ]
                roles: [ app-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[weblogic::wl_create_ds]"]
                jattrs:
                    weblogic:
                        wl_domain_port: 8080
                        wl_home: "/opt/oracle/middleware/wlserver_10.3/"
                        oracle_home: "/opt/oracle/middleware/"
                        ds:
                            ds_name: "oracle"
                            jndi_name: "oracle"
                            db_url: "jdbc:oracle:thin:@{$.db-hosts[0]}:1521:${db-sid}"
                            oracle_user: ${db-user}
                            oracle_user_pass: ${db-password}
        - deploy-app:
            action: install
            parameters:
                phase: deploy-app
                precedingPhases: [ configure-datasource, install-app ]
                roles: [ app-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[weblogic::wl_deploy_app]"]
                jattrs:
                    weblogic:
                        wl_domain_port: 8080
                        wl_home: "/opt/oracle/middleware/wlserver_10.3/"
                        oracle_home: "/opt/oracle/middleware/"
                        apps_array: [{
                          name: "PetClinic", path: "https://s3.amazonaws.com/petclinic/${app-fork}/origin/${app-branch}/petclinic-1.0.0-SNAPSHOT.war"
                        }]

        - setup-lb:
            action: haproxy.rebalance
            parameters:
                precedingPhases: [ deploy-app ]
                roles: [ lb-node ]
                jattrs:
                    haproxy.rebalance:
                        nodes: ${app-hosts}

    return:
        app-url:
            description: Application URL
            value: http://${lb-hosts}
        haproxy-url:
            description: HAProxy Admin URL
            value: http://${lb-hosts}:22002/
        app-servers:
            description: App tier IP addresses
            value: ${app-hosts}


scale-up:
    parameters:
        - app-count:
            description: Additional servers in app tier
            default: 1
            min: 1
            max: 20
        - app-fork:
            description: Source control fork
            default: "graven"
        - app-branch:
            description: Source control branch
            default: "oracle"
            enum:
                "Green": "oracle"
                "Red": "oracle-red"
        - db-user:
             description: Oracle DB user
             default: "JOHN"
        - db-password:
             description: Oracle DB user password
             default: "123qwe123"
        - db-sid:
             description: Oracle DB SID
             default: "DBORA"

    steps:
        - grow-app-tier:
            action: compute.grow
            parameters:
                vmIdentity: root
                imageId: us-east-1/ami-3aeb7853
                quantity: ${app-count}
                roleName: app-node
            output:
                app-hosts: ips


        - install-app:
            action: install
            parameters:
                phase: install-app
                roles: [ app-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[weblogic::wl_create_domain]", "recipe[weblogic::wl_domain_start]"]
                jattrs:
                    weblogic:
                        wl_domain_port: 8080
                        wl_home: "/opt/oracle/middleware/wlserver_10.3/"
                        oracle_home: "/opt/oracle/middleware/"
                        jdk: "/usr/java/latest"


        - configure-datasource:
            action: install
            parameters:
                phase: configure-datasource
                precedingPhases: [ install-app ]
                roles: [ app-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[weblogic::wl_create_ds]"]
                jattrs:
                    weblogic:
                        wl_domain_port: 8080
                        wl_home: "/opt/oracle/middleware/wlserver_10.3/"
                        oracle_home: "/opt/oracle/middleware/"
                        ds:
                            ds_name: "oracle"
                            jndi_name: "oracle"
                            db_url: "jdbc:oracle:thin:@{$.db-hosts[0]}:1521:${db-sid}"
                            oracle_user: ${db-user}
                            oracle_user_pass: ${db-password}
        - deploy-app:
            action: install
            parameters:
                phase: deploy-app
                precedingPhases: [ configure-datasource, install-app ]
                roles: [ app-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[weblogic::wl_deploy_app]"]
                jattrs:
                    weblogic:
                        wl_domain_port: 8080
                        wl_home: "/opt/oracle/middleware/wlserver_10.3/"
                        oracle_home: "/opt/oracle/middleware/"
                        apps_array: [{
                          name: "PetClinic", path: "https://s3.amazonaws.com/petclinic/${app-fork}/origin/${app-branch}/petclinic-1.0.0-SNAPSHOT.war"
                        }]

        - update-lb:
            action: haproxy.rebalance
            parameters:
                precedingPhases: [ deploy-app ]
                roles: [ lb-node ]
                jattrs:
                    haproxy.rebalance:
                        nodes: ${app-hosts}

scale-down:
    parameters:
        - app-count:
            description: Number of app tier servers to remove
            default: 1
            min: 1
            max: 20
    steps:
        - shrink-app-tier:
            action: compute.shrink
            parameters:
                roleName: app-node
                quantity: ${app-count}

        - update-lb:
            action: haproxy.rebalance
            parameters:
                precedingPhases: [ destroy ]
                roles: [ lb-node ]
                jattrs:
                    haproxy.rebalance:
                        nodes: ${app-hosts}

update:
    parameters:
        - app-fork:
            description: Source control fork
            default: "graven"
        - app-branch:
            description: Source control branch
            default: "oracle"
            enum:
                "Green": "oracle"
                "Red": "oracle-red"
        - db-user:
             description: Oracle DB user
             default: "JOHN"
        - db-password:
             description: Oracle DB password
             default: "123qwe123"
        - db-sid:
             description: Oracle DB SID
             default: "DBORA"

    steps:
        - configure-datasource:
            action: install
            parameters:
                phase: configure-datasource
                precedingPhases: [ install-app ]
                roles: [ app-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[weblogic::wl_create_ds]"]
                jattrs:
                    weblogic:
                        wl_domain_port: 8080
                        wl_home: "/opt/oracle/middleware/wlserver_10.3/"
                        oracle_home: "/opt/oracle/middleware/"
                        ds:
                            ds_name: "oracle"
                            jndi_name: "oracle"
                            db_url: "jdbc:oracle:thin:@{$.db-hosts[0]}:1521:${db-sid}"
                            oracle_user: ${db-user}
                            oracle_user_pass: ${db-password}
        - deploy-app:
            action: install
            parameters:
                phase: deploy-app
                precedingPhases: [ configure-datasource, install-app ]
                roles: [ app-node ]
                recipeUrl: "https://s3.amazonaws.com/adp-chef/oracle-0.1.tar.gz"
                runList: ["recipe[weblogic::wl_deploy_app]"]
                jattrs:
                    weblogic:
                        wl_domain_port: 8080
                        wl_home: "/opt/oracle/middleware/wlserver_10.3/"
                        oracle_home: "/opt/oracle/middleware/"
                        apps_array: [{
                          name: "PetClinic", path: "https://s3.amazonaws.com/petclinic/${app-fork}/origin/${app-branch}/petclinic-1.0.0-SNAPSHOT.war"
                        }]

destroy:
    steps:
        - destroy:
            action: compute.shrink-all
